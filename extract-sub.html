<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>字幕提取</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 24px;
        }

        h1 {
            font-size: 18px;
            margin: 0 0 12px;
        }

        .section {
            margin-bottom: 16px;
        }

        input[type=file] {
            margin-right: 8px;
        }

        textarea {
            width: 100%;
            height: 180px;
            box-sizing: border-box;
        }

        button {
            margin-right: 8px;
            margin-top: 8px;
        }

        #count {
            margin-left: 8px;
            color: #555;
        }

        #result {
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            max-height: 50vh;
            overflow: auto;
            background: #fafafa;
        }

        #result ol {
            margin: 0;
            padding-left: 24px;
        }

        #result li {
            line-height: 1.6;
        }

        footer {
            margin-top: 16px;
            color: #777;
        }
    </style>
</head>

<body>
    <h1>提取字幕内容</h1>
    <div class="section">
        <input id="file" type="file" accept=".srt,.md,.txt">
        <button id="parseFile">解析文件</button>
    </div>
    <div class="section">
        <textarea id="text" placeholder="或将字幕内容粘贴到此处"></textarea>
        <button id="parseText">解析文本</button>
        <button id="clear">清空</button>
        <span id="count"></span>
        <label for="chunk" style="margin-left:12px;">分段行数</label>
        <select id="chunk">
            <option value="10">10</option>
            <option value="30" selected>30</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
    <div id="result" class="section">
        <ol id="list"></ol>
    </div>
    <div class="section">
        <button id="copyAll">复制全部</button>
    </div>
    <script>
        function isIndex(line) { return /^\d+$/.test(line.trim()); }
        function isTimestamp(line) {
            var s = line.trim();
            var re = /^(\d{1,2}):\d{2}:\d{2}(?:[.,]\d{1,3})?\s*(?:-->\s*(\d{1,2}):\d{2}:\d{2}(?:[.,]\d{1,3})?)?/;
            return re.test(s);
        }
        function normalize(text) {
            return text.replace(/\uFEFF/g, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        }
        function parseSubs(text) {
            var lines = normalize(text).split('\n');
            var out = [];
            var i = 0;
            while (i < lines.length) {
                var line = lines[i];
                if (line.trim() === '') { i++; continue; }
                if (isIndex(line)) {
                    i++;
                    var ts = lines[i] || '';
                    if (isTimestamp(ts)) {
                        i++;
                        while (i < lines.length && lines[i].trim() !== '') {
                            out.push(lines[i].trim());
                            i++;
                        }
                    } else {
                        if (line.trim() !== '') { out.push(line.trim()); }
                        i++;
                    }
                } else {
                    i++;
                }
            }
            return out;
        }
        var lastSubs = [];
        function getChunkSize() {
            var el = document.getElementById('chunk');
            var v = parseInt(el.value, 10);
            return isNaN(v) ? 30 : v;
        }
        function buildParagraphs(lines, size) {
            var res = [];
            for (var i = 0; i < lines.length; i += size) {
                var seg = lines.slice(i, i + size);
                var parts = [];
                for (var j = 0; j < seg.length; j++) {
                    parts.push(seg[j] + '，');
                }
                res.push(parts.join(''));
            }
            return res;
        }
        function renderChunked() {
            var size = getChunkSize();
            var paragraphs = buildParagraphs(lastSubs, size);
            var ol = document.getElementById('list');
            ol.innerHTML = '';
            for (var j = 0; j < paragraphs.length; j++) {
                var li = document.createElement('li');
                li.textContent = paragraphs[j];
                ol.appendChild(li);
            }
            document.getElementById('count').textContent = paragraphs.length ? ('共 ' + paragraphs.length + ' 段') : '';
        }
        function handleText(text) {
            lastSubs = parseSubs(text);
            renderChunked();
        }
        document.getElementById('parseFile').addEventListener('click', function () {
            var f = document.getElementById('file').files[0];
            if (!f) { return; }
            var r = new FileReader();
            r.onload = function () { handleText(String(r.result)); };
            r.readAsText(f, 'utf-8');
        });
        document.getElementById('parseText').addEventListener('click', function () {
            var t = document.getElementById('text').value;
            handleText(t);
        });
        document.getElementById('chunk').addEventListener('change', function () {
            if (lastSubs.length) { renderChunked(); }
        });
        document.getElementById('clear').addEventListener('click', function () {
            document.getElementById('text').value = '';
            document.getElementById('list').innerHTML = '';
            document.getElementById('count').textContent = '';
            lastSubs = [];
        });
        document.getElementById('copyAll').addEventListener('click', function () {
            var items = document.querySelectorAll('#list li');
            var text = Array.prototype.map.call(items, function (el) { return el.textContent; }).join('\n');
            navigator.clipboard.writeText(text);
        });
    </script>
</body>

</html>
